name: Secret Scan (gitleaks)

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  gitleaks-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install gitleaks
        run: |
          # Install gitleaks CLI
          curl -sSfL https://raw.githubusercontent.com/zricethezav/gitleaks/main/install.sh | bash -s -- -b $HOME/.local/bin v8.2.0
          export PATH="$HOME/.local/bin:$PATH"

      - name: Run gitleaks scan
        env:
          GITLEAKS_PATH: ${{ runner.temp }}/gitleaks
        run: |
          # Run gitleaks and fail the job if leaks are detected
          $HOME/.local/bin/gitleaks detect --source . --report-path gitleaks-report.json --redact || (echo "GITLEAKS: leaks found" && exit 1)

      - name: Upload gitleaks report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
