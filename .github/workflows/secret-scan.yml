name: Secret Scan (gitleaks)

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  gitleaks-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install gitleaks
        run: |
          # Install gitleaks CLI
          curl -sSfL https://raw.githubusercontent.com/zricethezav/gitleaks/main/install.sh | bash -s -- -b $HOME/.local/bin v8.2.0
          export PATH="$HOME/.local/bin:$PATH"


      - name: Run gitleaks scan (strict config)
        env:
          GITLEAKS_PATH: ${{ runner.temp }}/gitleaks
        run: |
          # Run gitleaks with repository-specific config and fail the job if leaks are detected
          $HOME/.local/bin/gitleaks detect --source . --config-path .github/gitleaks-config.toml --report-path gitleaks-report.json --redact

      - name: Post findings as PR comment (if any)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'gitleaks-report.json';
            if (!fs.existsSync(path)) {
              core.info('No gitleaks report found');
              return;
            }
            const report = JSON.parse(fs.readFileSync(path, 'utf8'));
            if (!Array.isArray(report) || report.length === 0) {
              core.info('No leaks reported');
              return;
            }
            // Build a concise comment
            let body = '⚠️ gitleaks found potential secrets in this PR:\n\n';
            report.slice(0,10).forEach((r,i)=>{
              body += `- ${r.rule_id} (${r.description || 'match'}) at ${r.file}:${r.line}\n`;
            });
            body += '\nPlease remove secrets, rotate any exposed keys, and re-run the checks.';
            await github.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });

      - name: Upload gitleaks report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
